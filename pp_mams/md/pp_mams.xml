<mdscript name="pp_mams" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd" version="1">
  <params>
    <param name="notify" type="boolean" default="true" desc="Notification on assignment"/>
    <param name="logbook" type="boolean" default="true" desc="Assignment in Logbook"/>
  </params>
  <cues>
    <!-- Initialization cue -->
    <cue name="Init" instantiate="true">
      <conditions>
        <event_game_loaded />
      </conditions>
      <actions>
        <set_value name="$version" exact="'3.48'" />
        <set_value name="$method" exact="'event_control_entity_removed'" />

        <debug_text text="'=== PP MAMS v' + $version + ': Using ' + $method + ' ==='" />
        <debug_text text="'PP MAMS: v3.48 - Top-level cue signaling pattern!'" />
        <debug_text text="'PP MAMS: Init cue executed - version ' + $version" />

        <set_value name="global.$pp_mams_enabled" exact="true" />
        <set_value name="global.$pp_mams_debug" exact="true" />
        <set_value name="global.$pp_mams_version" exact="$version" />

        <show_notification caption="'PP MAMS v' + $version + ' Loaded'" text="'Automatic pilot replacement ACTIVE!'" />
        <write_to_logbook category="general" title="'PP MAMS v' + $version + ' Loaded'" text="'Pilot replacement system online - fire a pilot to test!'" />
        <debug_text text="'=== PP MAMS v' + $version + ': LOADING COMPLETE ==='" />

        <!-- YOSHIKO UEDA TRACKER: Find and track her location (optional debug feature) -->
        <set_value name="$yoshiko_found" exact="false" />
        <set_value name="global.$yoshiko_ship" exact="null" />
        <set_value name="global.$yoshiko_last_ship" exact="null" />

        <!-- Search all ships for Yoshiko Ueda -->
        <find_object name="$all_ships" class="ship" owner="faction.player" multiple="true" />
        <do_all exact="$all_ships.count" counter="$y">
          <set_value name="$check_ship" exact="$all_ships.{$y}" />
          <do_if value="@$check_ship.people.count gt 0">
            <!-- Check if pilot is Yoshiko -->
            <do_if value="$check_ship.pilot.exists and $check_ship.pilot.knownname == 'Yoshiko Ueda'">
              <set_value name="global.$yoshiko_ship" exact="$check_ship" />
              <set_value name="global.$yoshiko_last_ship" exact="$check_ship" />
              <set_value name="$yoshiko_found" exact="true" />
              <break/>
            </do_if>
          </do_if>
        </do_all>
      </actions>
    </cue>

    <!-- YOSHIKO TRACKER: Periodic location check -->
    <cue name="YoshikoTracker" instantiate="true">
      <conditions>
        <event_game_loaded />
      </conditions>
      <delay exact="10s" />
      <cues>
        <cue name="YoshikoCheckLoop" instantiate="true">
          <conditions>
            <check_any>
              <event_cue_completed cue="parent" />
              <event_cue_completed cue="YoshikoCheckLoop" />
            </check_any>
          </conditions>
          <delay exact="5s" />
          <actions>
            <do_if value="global.$yoshiko_ship and global.$yoshiko_ship.exists">
              <!-- Check if Yoshiko is still the pilot -->
              <do_if value="global.$yoshiko_ship.pilot.exists and global.$yoshiko_ship.pilot.knownname == 'Yoshiko Ueda'">
                <!-- Still on same ship, no change -->
              </do_if>
              <do_else>
                <!-- Yoshiko moved! Log the transfer -->
                <debug_text text="'PP MAMS: YOSHIKO TRANSFER DETECTED!'" />
                <debug_text text="'PP MAMS:   Previous ship: ' + @global.$yoshiko_last_ship.knownname + ' (' + @global.$yoshiko_last_ship.idcode + ')'" />
                <debug_text text="'PP MAMS:   Yoshiko no longer pilot on: ' + @global.$yoshiko_ship.knownname" />

                <!-- Search for her new location -->
                <find_object name="$search_ships" class="ship" owner="faction.player" multiple="true" />
                <set_value name="$found_new" exact="false" />
                <do_all exact="$search_ships.count" counter="$s">
                  <set_value name="$scan" exact="$search_ships.{$s}" />
                  <do_if value="$scan.pilot.exists and $scan.pilot.knownname == 'Yoshiko Ueda'">
                    <set_value name="global.$yoshiko_last_ship" exact="global.$yoshiko_ship" />
                    <set_value name="global.$yoshiko_ship" exact="$scan" />
                    <set_value name="$found_new" exact="true" />
                    <debug_text text="'PP MAMS:   New ship: ' + @$scan.knownname + ' (' + @$scan.idcode + ')'" />
                    <show_notification caption="'YOSHIKO TRANSFER!'" text="'From ' + @global.$yoshiko_last_ship.knownname + ' to ' + @$scan.knownname" />
                    <write_to_logbook category="general" title="'PP MAMS: Yoshiko Transfer'" text="'Yoshiko moved from ' + @global.$yoshiko_last_ship.knownname + ' to ' + @$scan.knownname" />
                    <break/>
                  </do_if>
                </do_all>

                <do_if value="not $found_new">
                  <debug_text text="'PP MAMS:   Yoshiko not found as pilot anywhere (may be fired or reassigned to non-pilot role)'" />
                  <set_value name="global.$yoshiko_ship" exact="null" />
                </do_if>
              </do_else>
            </do_if>
          </actions>
        </cue>
      </cues>
    </cue>

    <!-- EVENT-DRIVEN: Listen for fire conversation section -->
    <cue name="PilotFireListener" instantiate="true">
      <conditions>
        <event_conversation_next_section />
      </conditions>
      <actions>
        <!-- Check if this is the fire confirmation or actual fire action -->
        <do_if value="event.param == 'g_fire' or event.param == 'g_pilotleave'">
          <!-- Store the ship and NPC for reference -->
          <set_value name="$fired_npc" exact="event.object" />
          <set_value name="$ship" exact="$fired_npc.container" />

          <!-- DETECTION: Pilot firing confirmed -->
          <do_if value="$fired_npc.controlpost == controlpost.aipilot">
            <show_notification caption="'PP MAMS Alert!'" text="'Pilot fired from ' + @$ship.knownname + '!'" />
            <write_to_logbook category="general" title="'PP MAMS: Pilot Deficit'" text="'Ship ' + @$ship.knownname + ' ('+@$ship.idcode+') fired pilot: ' + @$fired_npc.knownname" />

            <!-- Signal top-level handler cue with ship reference -->
            <signal_cue_instantly cue="PilotReplacementHandler" param="$ship"/>
          </do_if>
        </do_if>
      </actions>
    </cue>

    <!-- Top-level handler: Wait for pilot removal signal, then wait for actual removal -->
    <cue name="PilotReplacementHandler" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$target_ship" exact="event.param"/>
      </actions>
      <cues>
        <cue name="WaitForRemoval">
          <conditions>
            <event_control_entity_removed object="$target_ship"/>
          </conditions>
          <actions>
            <!-- REPLACEMENT LOGIC v6: Signal-based with proper object reference -->
            <set_value name="$candidates" exact="[]" />
            <set_value name="$candidate_ships" exact="[]" />
            <set_value name="$candidate_skills" exact="[]" />

            <!-- Find all player ships -->
            <find_object name="$all_ships" class="ship" owner="faction.player" multiple="true" />

            <!-- Build candidate pool using find_object_component -->
            <do_all exact="$all_ships.count" counter="$i">
              <set_value name="$scan_ship" exact="$all_ships.{$i}" />

              <!-- Skip same ship (no point moving pilot from same ship) -->
              <do_if value="$scan_ship != $target_ship">

                <!-- Find all NPCs on this ship -->
                <find_object_component name="$ship_npcs" class="class.npc" object="$scan_ship" multiple="true" />

                <!-- Check each NPC -->
                <do_for_each name="$npc" in="$ship_npcs">

                  <!-- Filter 1: NEVER touch managers! -->
                  <do_if value="$npc.controlpost != controlpost.manager">

                    <!-- Filter 2: Must have pilot skill -->
                    <do_if value="@$npc.potentialskill.{controlpost.aipilot} gt 0">

                      <!-- Add to candidate pool -->
                      <append_to_list name="$candidates" exact="$npc" />
                      <append_to_list name="$candidate_ships" exact="$scan_ship" />
                      <append_to_list name="$candidate_skills" exact="$npc.potentialskill.{controlpost.aipilot}" />

                    </do_if>
                  </do_if>
                </do_for_each>
              </do_if>
            </do_all>

            <!-- Find best candidate by skill -->
            <do_if value="$candidates.count gt 0">
              <set_value name="$best_index" exact="-1" />
              <set_value name="$best_skill" exact="-1" />

              <do_all exact="$candidate_skills.count" counter="$k">
                <do_if value="$candidate_skills.{$k} gt $best_skill">
                  <set_value name="$best_index" exact="$k" />
                  <set_value name="$best_skill" exact="$candidate_skills.{$k}" />
                </do_if>
              </do_all>

              <!-- Get best candidate NPC entity -->
              <set_value name="$best_npc" exact="$candidates.{$best_index}" />
              <set_value name="$source_ship" exact="$candidate_ships.{$best_index}" />

              <!-- ASSIGNMENT: Transfer NPC to target ship as pilot -->
              <assign_control_entity actor="$best_npc" object="$target_ship" post="controlpost.aipilot" init="true" transfer="true"/>

              <show_notification caption="'PP MAMS: Pilot Assigned!'" text="@$best_npc.knownname + ' (skill: ' + $best_skill + ') → ' + @$target_ship.knownname" />
              <write_to_logbook category="general" title="'PP MAMS: Pilot Assigned'" text="'Assigned ' + @$best_npc.knownname + ' (skill: ' + $best_skill + ') from ' + @$source_ship.knownname + ' to ' + @$target_ship.knownname" />
            </do_if>
            <do_else>
              <show_notification caption="'PP MAMS: No Candidates'" text="'No eligible crew found to replace pilot on ' + @$target_ship.knownname" />
            </do_else>
          </actions>
        </cue>
      </cues>
    </cue>

    <!-- EVENT MONITORS: Track game events for debugging - DEBUG ONLY, NO NOTIFICATIONS -->
    <!-- DISABLED: Too spammy at game start
    <cue name="EventMonitor_NPCCreated" instantiate="true">
      <conditions>
        <event_npc_created />
      </conditions>
      <actions>
        <debug_text text="'PP MAMS: event_npc_created fired! NPC: ' + @event.param.knownname" />
        <! Notification disabled - too many NPCs spawn at game start ->
      </actions>
    </cue>
    -->

    <cue name="EventMonitor_PlatformActor" instantiate="true">
      <conditions>
        <event_platform_actor_created />
      </conditions>
      <actions>
        <debug_text text="'PP MAMS: event_platform_actor_created fired! Actor: ' + @event.param.knownname + ', Type: ' + @event.param2" />
        <!-- Notification disabled - too many actors spawn at game start -->
      </actions>
    </cue>

    <!-- LEGACY: Periodic Fleet Scanner (COMMENTED OUT - keeping for reference)
    <cue name="FleetScanner" instantiate="true">
      <conditions>
        <event_game_loaded />
      </conditions>
      <delay exact="5s" />
      <actions>
        <debug_text text="'PP MAMS: Starting fast 10-second scanner'" />
        <show_notification caption="'PP MAMS v3.08'" text="'Fast 10s scanner active'" />
      </actions>
      <cues>
        <cue name="ScanLoop" instantiate="true">
          <conditions>
            <check_any>
              <event_cue_completed cue="parent" />
              <event_cue_completed cue="ScanLoop" />
            </check_any>
          </conditions>
          <delay exact="10s" />
          <actions>
            <debug_text text="'PP MAMS: Periodic scan running...'" />

            <set_value name="$deficit_count" exact="0" />
            <set_value name="$total_ships" exact="0" />

            <find_ship name="$player_ships" space="player.galaxy" owner="faction.player" multiple="true" />

            <do_if value="$player_ships" and="$player_ships.exists">
              <set_value name="$total_ships" exact="@$player_ships.count" />
              <debug_text text="'PP MAMS: Found ' + $total_ships + ' player ships'" />

              <do_all exact="$total_ships" counter="$i">
                <set_value name="$ship" exact="$player_ships.{$i}" />

                <do_if value="$ship.pilot" and="$ship.pilot.exists">
                  <debug_text text="'PP MAMS: ' + @$ship.knownname + ' has pilot'" />
                </do_if>
                <do_else>
                  <set_value name="$deficit_count" exact="$deficit_count + 1" />
                  <debug_text text="'PP MAMS: PILOT DEFICIT - ' + @$ship.knownname + ' (periodic scan)'" />
                </do_else>
              </do_all>
            </do_if>

            <debug_text text="'PP MAMS: Scan complete - ' + $deficit_count + ' deficits in ' + $total_ships + ' ships'" />

            <do_if value="$deficit_count gt 0">
              <show_notification caption="'PP MAMS Alert'" text="$deficit_count + ' pilot deficit(s) detected (periodic scan)'" />
              <write_to_logbook category="general" title="'PP MAMS Alert'" text="'PP MAMS: ' + $deficit_count + ' pilot deficit(s) detected via periodic scan'" />
            </do_if>
          </actions>
        </cue>
      </cues>
    </cue>
    -->

  </cues>
</mdscript>