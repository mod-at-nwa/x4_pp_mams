<mdscript name="pp_mams" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd" version="1">
  <params>
    <param name="notify" type="boolean" default="true" desc="Notification on assignment"/>
    <param name="logbook" type="boolean" default="true" desc="Assignment in Logbook"/>
  </params>
  <cues>
    <!-- Initialization cue -->
    <cue name="Init" instantiate="true">
      <conditions>
        <event_game_loaded />
      </conditions>
      <actions>
        <set_value name="$version" exact="'3.26'" />
        <set_value name="$method" exact="'event_conversation_next_section'" />

        <debug_text text="'=== PP MAMS v' + $version + ': Using ' + $method + ' ==='" />
        <debug_text text="'PP MAMS: Event-driven detection via conversation sections!'" />
        <debug_text text="'PP MAMS: Init cue executed - version ' + $version" />

        <set_value name="global.$pp_mams_enabled" exact="true" />
        <set_value name="global.$pp_mams_debug" exact="true" />
        <set_value name="global.$pp_mams_version" exact="$version" />

        <show_notification caption="'PP MAMS v' + $version + ' Loaded'" text="'Event-driven conversation monitoring active!'" />
        <write_to_logbook category="general" title="'PP MAMS v' + $version + ' Loaded'" text="'Using ' + $method + ' for instant pilot fire detection!'" />
        <debug_text text="'=== PP MAMS v' + $version + ': LOADING COMPLETE ==='" />

        <!-- API DISCOVERY: Test personnel filtering -->
        <debug_text text="'PP MAMS: === TESTING PERSONNEL FILTERING ==='" />

        <!-- Get all NPCs -->
        <find_object name="$all_npcs" class="npc" owner="faction.player" multiple="true" />
        <debug_text text="'PP MAMS: Total NPCs: ' + $all_npcs.count" />

        <!-- Sample typenames to understand what we're dealing with -->
        <debug_text text="'PP MAMS: Sampling NPC typenames...'" />
        <debug_text text="'PP MAMS: NPC 1: ' + @$all_npcs.{1}.typename + ' / ' + @$all_npcs.{1}.knownname + ' / container: ' + @$all_npcs.{1}.container.knownname" />
        <debug_text text="'PP MAMS: NPC 10: ' + @$all_npcs.{10}.typename + ' / ' + @$all_npcs.{10}.knownname + ' / container: ' + @$all_npcs.{10}.container.knownname" />
        <debug_text text="'PP MAMS: NPC 50: ' + @$all_npcs.{50}.typename + ' / ' + @$all_npcs.{50}.knownname + ' / container: ' + @$all_npcs.{50}.container.knownname" />
        <debug_text text="'PP MAMS: NPC 100: ' + @$all_npcs.{100}.typename + ' / ' + @$all_npcs.{100}.knownname + ' / container: ' + @$all_npcs.{100}.container.knownname" />
        <debug_text text="'PP MAMS: NPC 500: ' + @$all_npcs.{500}.typename + ' / ' + @$all_npcs.{500}.knownname + ' / container: ' + @$all_npcs.{500}.container.knownname" />
      </actions>
    </cue>

    <!-- EVENT-DRIVEN: Listen for fire conversation section -->
    <cue name="PilotFireListener" instantiate="true">
      <conditions>
        <event_conversation_next_section />
      </conditions>
      <actions>
        <debug_text text="'PP MAMS: Conversation section changed to: ' + event.param" />

        <!-- Check if this is the fire confirmation or actual fire action -->
        <do_if value="event.param == 'g_fire' or event.param == 'g_pilotleave'">
          <debug_text text="'PP MAMS: FIRING DETECTED!'" />

          <!-- Store the ship and NPC for reference -->
          <set_value name="$fired_npc" exact="event.object" />
          <set_value name="$ship" exact="$fired_npc.container" />

          <!-- DEBUG: Output ALL relevant properties for analysis -->
          <debug_text text="'PP MAMS: --- NPC Properties ---'" />
          <debug_text text="'PP MAMS:   typename: ' + @$fired_npc.typename" />
          <debug_text text="'PP MAMS:   knownname: ' + @$fired_npc.knownname" />
          <debug_text text="'PP MAMS:   entityrole: ' + @$fired_npc.entityrole" />
          <debug_text text="'PP MAMS:   post: ' + @$fired_npc.post" />
          <debug_text text="'PP MAMS:   combinedskill.piloting: ' + @$fired_npc.combinedskill.{skill.piloting}" />
          <debug_text text="'PP MAMS: --- Ship Properties ---'" />
          <debug_text text="'PP MAMS:   ship.id: ' + $ship" />
          <debug_text text="'PP MAMS:   ship.idcode: ' + @$ship.idcode" />
          <debug_text text="'PP MAMS:   ship.knownname: ' + @$ship.knownname" />
          <debug_text text="'PP MAMS:   ship.pilot.exists: ' + $ship.pilot.exists" />
          <debug_text text="'PP MAMS:   ship.pilot.knownname: ' + @$ship.pilot.knownname" />
          <debug_text text="'PP MAMS: --- Test Conditions ---'" />
          <debug_text text="'PP MAMS:   typename==pilot: ' + ($fired_npc.typename == 'pilot')" />
          <debug_text text="'PP MAMS:   entityrole==pilot: ' + ($fired_npc.entityrole == entityrole.pilot)" />
          <debug_text text="'PP MAMS:   post==aipilot: ' + ($fired_npc.post == controlpost.aipilot)" />
          <debug_text text="'PP MAMS:   has piloting skill: ' + ($fired_npc.combinedskill.{skill.piloting} gt 0)" />

          <!-- ORIGINAL CHECK: Keep for comparison -->
          <do_if value="$fired_npc.typename == 'pilot'">
            <show_notification caption="'PP MAMS Alert (typename)!'" text="'Pilot fired from ' + @$ship.knownname + '!'" />
            <write_to_logbook category="general" title="'PP MAMS: Pilot Deficit (typename)'" text="'Ship ' + @$ship.knownname + ' fired pilot: ' + @$fired_npc.knownname" />
          </do_if>

          <!-- TEST: Alternative checks -->
          <do_if value="$fired_npc.entityrole == entityrole.pilot">
            <show_notification caption="'PP MAMS Alert (entityrole)!'" text="'Pilot fired from ' + @$ship.knownname + '!'" />
            <write_to_logbook category="general" title="'PP MAMS: Pilot Deficit (entityrole)'" text="'Ship ' + @$ship.knownname + ' fired pilot: ' + @$fired_npc.knownname" />
          </do_if>
        </do_if>
      </actions>
    </cue>

    <!-- EVENT MONITORS: Track game events for debugging - DEBUG ONLY, NO NOTIFICATIONS -->
    <!-- DISABLED: Too spammy at game start
    <cue name="EventMonitor_NPCCreated" instantiate="true">
      <conditions>
        <event_npc_created />
      </conditions>
      <actions>
        <debug_text text="'PP MAMS: event_npc_created fired! NPC: ' + @event.param.knownname" />
        <! Notification disabled - too many NPCs spawn at game start ->
      </actions>
    </cue>
    -->

    <cue name="EventMonitor_PlatformActor" instantiate="true">
      <conditions>
        <event_platform_actor_created />
      </conditions>
      <actions>
        <debug_text text="'PP MAMS: event_platform_actor_created fired! Actor: ' + @event.param.knownname + ', Type: ' + @event.param2" />
        <!-- Notification disabled - too many actors spawn at game start -->
      </actions>
    </cue>

    <!-- LEGACY: Periodic Fleet Scanner (COMMENTED OUT - keeping for reference)
    <cue name="FleetScanner" instantiate="true">
      <conditions>
        <event_game_loaded />
      </conditions>
      <delay exact="5s" />
      <actions>
        <debug_text text="'PP MAMS: Starting fast 10-second scanner'" />
        <show_notification caption="'PP MAMS v3.08'" text="'Fast 10s scanner active'" />
      </actions>
      <cues>
        <cue name="ScanLoop" instantiate="true">
          <conditions>
            <check_any>
              <event_cue_completed cue="parent" />
              <event_cue_completed cue="ScanLoop" />
            </check_any>
          </conditions>
          <delay exact="10s" />
          <actions>
            <debug_text text="'PP MAMS: Periodic scan running...'" />

            <set_value name="$deficit_count" exact="0" />
            <set_value name="$total_ships" exact="0" />

            <find_ship name="$player_ships" space="player.galaxy" owner="faction.player" multiple="true" />

            <do_if value="$player_ships" and="$player_ships.exists">
              <set_value name="$total_ships" exact="@$player_ships.count" />
              <debug_text text="'PP MAMS: Found ' + $total_ships + ' player ships'" />

              <do_all exact="$total_ships" counter="$i">
                <set_value name="$ship" exact="$player_ships.{$i}" />

                <do_if value="$ship.pilot" and="$ship.pilot.exists">
                  <debug_text text="'PP MAMS: ' + @$ship.knownname + ' has pilot'" />
                </do_if>
                <do_else>
                  <set_value name="$deficit_count" exact="$deficit_count + 1" />
                  <debug_text text="'PP MAMS: PILOT DEFICIT - ' + @$ship.knownname + ' (periodic scan)'" />
                </do_else>
              </do_all>
            </do_if>

            <debug_text text="'PP MAMS: Scan complete - ' + $deficit_count + ' deficits in ' + $total_ships + ' ships'" />

            <do_if value="$deficit_count gt 0">
              <show_notification caption="'PP MAMS Alert'" text="$deficit_count + ' pilot deficit(s) detected (periodic scan)'" />
              <write_to_logbook category="general" title="'PP MAMS Alert'" text="'PP MAMS: ' + $deficit_count + ' pilot deficit(s) detected via periodic scan'" />
            </do_if>
          </actions>
        </cue>
      </cues>
    </cue>
    -->

  </cues>
</mdscript>