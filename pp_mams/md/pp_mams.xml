<mdscript name="pp_mams" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd" version="1">
  <params>
    <param name="notify" type="boolean" default="true" desc="Notification on assignment"/>
    <param name="logbook" type="boolean" default="true" desc="Assignment in Logbook"/>
  </params>
  <cues>
    <!-- Initialization cue -->
    <cue name="Init" instantiate="true">
      <conditions>
        <event_game_loaded />
      </conditions>
      <actions>
        <debug_text text="'=== PP MAMS v3.04: CORRECTED SCANNER LOADING ==='" />
        <debug_text text="'PP MAMS: Mod loaded and initialized successfully!'" />
        <debug_text text="'PP MAMS: Init cue executed - version 3.04'" />

        <set_value name="global.$pp_mams_enabled" exact="true" />
        <set_value name="global.$pp_mams_debug" exact="true" />

        <show_notification caption="'PP MAMS v3.04 Loaded'" text="'Corrected pilot detection active'" />
        <write_to_logbook category="general" title="'PP MAMS v3.04 Loaded'" text="'PP MAMS: find_object_component scanner ready'" />
        <debug_text text="'=== PP MAMS v3.04: LOADING COMPLETE ==='" />
      </actions>
    </cue>

    <!-- Simple Periodic Fleet Scanner -->
    <cue name="FleetScanner" instantiate="true">
      <conditions>
        <event_game_loaded />
      </conditions>
      <delay exact="5s" />
      <actions>
        <debug_text text="'PP MAMS: Starting corrected scanner - first scan in 5 seconds'" />
        <show_notification caption="'PP MAMS Scanner'" text="'Corrected scanner starting in 5 seconds'" />
      </actions>
      <cues>
        <cue name="ScanLoop" instantiate="true">
          <conditions>
            <check_any>
              <event_cue_completed cue="parent" />
              <event_cue_completed cue="ScanLoop" />
            </check_any>
          </conditions>
          <delay exact="30s" />
          <actions>
            <debug_text text="'PP MAMS: scanning fleet...'" />
            <show_notification caption="'PP MAMS'" text="'PP MAMS: scanning fleet...'" />

            <set_value name="$deficit_count" exact="0" />
            <set_value name="$total_ships" exact="0" />

            <!-- Corrected Method: find_object_component (proven to work) -->
            <debug_text text="'PP MAMS: Using find_object_component to find player ships...'" />
            <find_object_component name="$player_ships" space="player.galaxy" owner="faction.player" class="class.ship" multiple="true" />

            <do_if value="$player_ships" and="$player_ships.exists">
              <set_value name="$total_ships" exact="@$player_ships.count" />
              <debug_text text="'PP MAMS: Found ' + $total_ships + ' player ships'" />

              <do_all exact="$total_ships" counter="$i">
                <set_value name="$ship" exact="$player_ships.{$i}" />
                <debug_text text="'PP MAMS: Checking ship ' + @$ship.knownname + ' (' + @$ship.id + ')'" />

                <!-- Check pilot using proven pattern from working mods -->
                <do_if value="$ship.pilot" and="$ship.pilot.exists">
                  <debug_text text="'PP MAMS: Ship ' + @$ship.knownname + ' has pilot: ' + @$ship.pilot.knownname" />
                </do_if>
                <do_else>
                  <set_value name="$deficit_count" exact="$deficit_count + 1" />
                  <debug_text text="'PP MAMS: PILOT DEFICIT DETECTED - ' + @$ship.knownname + ' (' + @$ship.id + ') has no pilot'" />
                </do_else>
              </do_all>
            </do_if>
            <do_else>
              <debug_text text="'PP MAMS: find_object_component returned null or no player ships found'" />
            </do_else>

            <debug_text text="'PP MAMS: Scan complete - ' + $deficit_count + ' deficits in ' + $total_ships + ' ships'" />

            <do_if value="$deficit_count gt 0">
              <set_value name="$message" exact="'PP MAMS: ' + $deficit_count + ' pilot deficit(s) detected'" />
              <show_notification caption="'PP MAMS Alert'" text="$message" />
              <write_to_logbook category="general" title="'PP MAMS Alert'" text="'PP MAMS: ' + $deficit_count + ' pilot deficit(s) detected'" />
            </do_if>
            <do_else>
              <show_notification caption="'PP MAMS Scan'" text="'All ships have pilots'" />
            </do_else>
          </actions>
        </cue>
      </cues>
    </cue>

  </cues>
</mdscript>