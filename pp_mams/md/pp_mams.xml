<mdscript name="pp_mams" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd" version="1">
  <params>
    <param name="notify" type="boolean" default="true" desc="Notification on assignment"/>
    <param name="logbook" type="boolean" default="true" desc="Assignment in Logbook"/>
  </params>
  <cues>
    <!-- Initialization cue -->
    <cue name="Init" instantiate="true">
      <conditions>
        <event_game_loaded />
      </conditions>
      <actions>
        <debug_text text="'=== PP MAMS v3.0: SIMPLE SCANNER LOADING ==='" />
        <debug_text text="'PP MAMS: Mod loaded and initialized successfully!'" />
        <debug_text text="'PP MAMS: Init cue executed - version 3.0'" />

        <set_value name="global.$pp_mams_enabled" exact="true" />
        <set_value name="global.$pp_mams_debug" exact="true" />

        <show_notification caption="'PP MAMS v3.0 Loaded'" text="'Simple fleet scanner active'" />
        <write_to_logbook category="general" title="'PP MAMS v3.0 Loaded'" text="'PP MAMS: Simple fleet scanner ready'" />
        <debug_text text="'=== PP MAMS v3.0: LOADING COMPLETE ==='" />
      </actions>
    </cue>

    <!-- Simple Periodic Fleet Scanner -->
    <cue name="PeriodicFleetScanner" instantiate="true">
      <conditions>
        <event_game_loaded />
      </conditions>
      <actions>
        <debug_text text="'PP MAMS: Starting periodic fleet scanner (30 second intervals)'" />
      </actions>
      <cues>
        <cue name="ScanTimer" instantiate="true">
          <conditions>
            <check_any>
              <event_cue_completed cue="parent" />
              <event_cue_completed cue="ScanTimer" />
            </check_any>
          </conditions>
          <delay exact="30s" />
          <actions>
            <debug_text text="'PP MAMS: Scanning fleet for pilot deficits...'" />
            <set_value name="$deficit_count" exact="0" />
            <set_value name="$total_ships" exact="0" />
            <set_value name="$deficit_ships" exact="[]" />

            <find_object_component name="$player_ships" object="player.galaxy" class="ship" owner="faction.player" space="player.galaxy" />
            <set_value name="$total_ships" exact="$player_ships.count" />

            <do_all exact="$player_ships.count" counter="$i">
              <set_value name="$ship" exact="$player_ships.{$i}" />
              <do_if value="not $ship.pilot.exists">
                <set_value name="$deficit_count" exact="$deficit_count + 1" />
                <append_to_list name="$deficit_ships" exact="$ship.knownname" />
                <debug_text text="'PP MAMS: PILOT DEFICIT - ' + $ship.knownname" />
              </do_if>
            </do_all>

            <debug_text text="'PP MAMS: Scan complete - ' + $deficit_count + ' deficits found in ' + $total_ships + ' ships'" />

            <do_if value="$deficit_count gt 0">
              <set_value name="$message" exact="'PP MAMS: ' + $deficit_count + ' pilot deficit(s) detected'" />
              <show_notification caption="'PP MAMS Alert'" text="$message" />
              <debug_text text="$message" />
            </do_if>
          </actions>
        </cue>
      </cues>
    </cue>

  </cues>
</mdscript>