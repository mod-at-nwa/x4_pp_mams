<mdscript name="pp_mams" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd" version="1">
  <params>
    <param name="notify" type="boolean" default="true" desc="Notification on assignment"/>
    <param name="logbook" type="boolean" default="true" desc="Assignment in Logbook"/>
  </params>
  <cues>
    <!-- Initialization cue -->
    <cue name="Init" instantiate="true">
      <conditions>
        <event_game_loaded />
      </conditions>
      <actions>
        <debug_text text="'=== PP MAMS v3.11: XPath v4 from extracted files ==='" />
        <debug_text text="'PP MAMS: Patched LogFired via conversations.xml diff!'" />
        <debug_text text="'PP MAMS: Init cue executed - version 3.11'" />

        <set_value name="global.$pp_mams_enabled" exact="true" />
        <set_value name="global.$pp_mams_debug" exact="true" />

        <show_notification caption="'PP MAMS v3.11 Loaded'" text="'XPath v4 - extracted game structure!'" />
        <write_to_logbook category="general" title="'PP MAMS v3.11 Loaded'" text="'XPath v4 based on extracted conversations.xml structure'" />
        <debug_text text="'=== PP MAMS v3.11: LOADING COMPLETE ==='" />
      </actions>
    </cue>

    <!-- EVENT-DRIVEN: Listen for pilot firing via md.Conversations.LogFired -->
    <cue name="PilotFiredListener" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.Conversations.LogFired" />
      </conditions>
      <actions>
        <!-- event.param contains the fired actor -->
        <set_value name="$fired_actor" exact="event.param" />

        <debug_text text="'PP MAMS: PILOT FIRED EVENT DETECTED!'" />
        <debug_text text="'PP MAMS: Fired actor: ' + @$fired_actor.typename + ' - ' + @$fired_actor.knownname" />
        <debug_text text="'PP MAMS: Previously assigned to: ' + @$fired_actor.container.knownname" />

        <!-- Check if this was a pilot (not other crew types) -->
        <do_if value="$fired_actor.typename == 'pilot'">
          <debug_text text="'PP MAMS: PILOT DEFICIT CREATED - checking ship...'" />

          <!-- Find the ship that just lost its pilot -->
          <set_value name="$ship" exact="$fired_actor.container" />

          <do_if value="$ship.isclass.ship">
            <show_notification caption="'PP MAMS Alert!'" text="'Pilot fired from ' + @$ship.knownname + '!'" />
            <write_to_logbook category="general" title="'PP MAMS: Pilot Deficit'" text="'Ship ' + @$ship.knownname + ' lost pilot: ' + @$fired_actor.knownname" />
            <debug_text text="'PP MAMS: Ship ' + @$ship.knownname + ' now has pilot deficit'" />
          </do_if>
        </do_if>
        <do_else>
          <debug_text text="'PP MAMS: Fired crew member was not a pilot (' + @$fired_actor.typename + ')'" />
        </do_else>
      </actions>
    </cue>

    <!-- EVENT MONITORS: Track game events for debugging - DEBUG ONLY, NO NOTIFICATIONS -->
    <cue name="EventMonitor_NPCCreated" instantiate="true">
      <conditions>
        <event_npc_created />
      </conditions>
      <actions>
        <debug_text text="'PP MAMS: event_npc_created fired! NPC: ' + @event.param.knownname" />
        <!-- Notification disabled - too many NPCs spawn at game start -->
      </actions>
    </cue>

    <cue name="EventMonitor_PlatformActor" instantiate="true">
      <conditions>
        <event_platform_actor_created />
      </conditions>
      <actions>
        <debug_text text="'PP MAMS: event_platform_actor_created fired! Actor: ' + @event.param.knownname + ', Type: ' + @event.param2" />
        <!-- Notification disabled - too many actors spawn at game start -->
      </actions>
    </cue>

    <!-- LEGACY: Periodic Fleet Scanner (COMMENTED OUT - keeping for reference)
    <cue name="FleetScanner" instantiate="true">
      <conditions>
        <event_game_loaded />
      </conditions>
      <delay exact="5s" />
      <actions>
        <debug_text text="'PP MAMS: Starting fast 10-second scanner'" />
        <show_notification caption="'PP MAMS v3.08'" text="'Fast 10s scanner active'" />
      </actions>
      <cues>
        <cue name="ScanLoop" instantiate="true">
          <conditions>
            <check_any>
              <event_cue_completed cue="parent" />
              <event_cue_completed cue="ScanLoop" />
            </check_any>
          </conditions>
          <delay exact="10s" />
          <actions>
            <debug_text text="'PP MAMS: Periodic scan running...'" />

            <set_value name="$deficit_count" exact="0" />
            <set_value name="$total_ships" exact="0" />

            <find_ship name="$player_ships" space="player.galaxy" owner="faction.player" multiple="true" />

            <do_if value="$player_ships" and="$player_ships.exists">
              <set_value name="$total_ships" exact="@$player_ships.count" />
              <debug_text text="'PP MAMS: Found ' + $total_ships + ' player ships'" />

              <do_all exact="$total_ships" counter="$i">
                <set_value name="$ship" exact="$player_ships.{$i}" />

                <do_if value="$ship.pilot" and="$ship.pilot.exists">
                  <debug_text text="'PP MAMS: ' + @$ship.knownname + ' has pilot'" />
                </do_if>
                <do_else>
                  <set_value name="$deficit_count" exact="$deficit_count + 1" />
                  <debug_text text="'PP MAMS: PILOT DEFICIT - ' + @$ship.knownname + ' (periodic scan)'" />
                </do_else>
              </do_all>
            </do_if>

            <debug_text text="'PP MAMS: Scan complete - ' + $deficit_count + ' deficits in ' + $total_ships + ' ships'" />

            <do_if value="$deficit_count gt 0">
              <show_notification caption="'PP MAMS Alert'" text="$deficit_count + ' pilot deficit(s) detected (periodic scan)'" />
              <write_to_logbook category="general" title="'PP MAMS Alert'" text="'PP MAMS: ' + $deficit_count + ' pilot deficit(s) detected via periodic scan'" />
            </do_if>
          </actions>
        </cue>
      </cues>
    </cue>
    -->

  </cues>
</mdscript>